# Synthesis — Phase 3 Architecture Insights

## Comparative Analysis: PATH-B (Custom ROM) vs. PATH-C (Magisk Module)

This document synthesizes the architectural trade-offs discovered during Phase 3 dual-track
development of AudioShift. Both paths achieve the same user-visible goal — transparent 432 Hz
pitch shifting of all music audio output — through fundamentally different system integration
strategies.

---

## Executive Summary

| Dimension | PATH-B (Custom ROM / AOSP) | PATH-C (Magisk + Effects API) |
|-----------|---------------------------|-------------------------------|
| **Integration depth** | Kernel of Android audio stack | API surface of Android audio stack |
| **Knox impact** | Permanent fuse blow | Permanent fuse blow (same) |
| **Reversibility** | Flash stock ROM | Uninstall Magisk module |
| **Build complexity** | Very high (full AOSP build) | Low (NDK + CMake) |
| **Distribution** | OTA-style ROM ZIP | Magisk module ZIP |
| **Update friction** | Full ROM reflash | Module ZIP swap |
| **Effect guarantee** | 100% of audio output | ~95% (Samsung AudioSolution caveat) |
| **Latency** | Configurable, ~5–15 ms | Fixed ~20 ms (SoundTouch WSOLA) |
| **OEM UI preserved** | No (AOSP UI) | Yes (Samsung OneUI intact) |
| **Development iteration** | Days per cycle | Minutes per cycle |

---

## PATH-B: AudioFlinger Source Modification

### Architecture

PATH-B modifies `frameworks/av/services/audioflinger/` to intercept audio at the `AudioFlinger::PlaybackThread::threadLoop_mix()` stage — the point where mixed PCM data is assembled before being sent to the HAL. A SoundTouch pipeline is injected at this layer.

```
Application (MediaPlayer, ExoPlayer, …)
    │ AudioTrack write()
    ▼
AudioFlinger:MixerThread
    │ threadLoop_mix() — [PATH-B INJECTION POINT]
    │  ↓ pcm data → SoundTouch WSOLA → shifted pcm
    ▼
Audio HAL (AIDL)
    ▼
Hardware (Snapdragon 8 Elite / WCD9395 codec)
    ▼
Speaker / Headphone output
```

### Strengths

1. **Deterministic coverage**: Every stream that passes through the mixer is shifted, regardless of
   how it's routed. No AudioPolicy allowlists can suppress it.
2. **Lower-latency potential**: By integrating directly in the mixer loop, the SoundTouch pipeline
   shares the hardware callback period (~5 ms at 48 kHz / 256 frames). No extra buffering inserted.
3. **Full control**: Can apply different pitch ratios to different stream types. Can bypass based on
   app UID, audio attributes, or any custom logic accessible at that layer.

### Weaknesses

1. **Build complexity**: Requires a complete AOSP 14 build environment — ~200 GB disk, 16+ GB RAM,
   multi-hour compile times. Iteration is painful.
2. **Knox impact**: Bootloader unlock + custom ROM flashes both tabs, tripling the eFuse risk exposure
   (unlock + flash 1 + flash 2 if something goes wrong).
3. **OEM feature loss**: Full Samsung OneUI features (DeX, Samsung Pay, Samsung Health ECG sensor,
   camera processing pipeline) are lost or degraded on AOSP.
4. **Maintenance burden**: Every Android security patch or Samsung OTA requires re-applying the
   AudioFlinger patch, rebuilding, and reflashing.

---

## PATH-C: Android Effects API (Magisk Overlay)

### Architecture

PATH-C registers a standard Android Audio Effect plugin (`.so`) through the published
`effect_interface_s` / `effect_handle_t` API. AudioFlinger applies it as a postprocess insert
on the music stream.

```
Application (MediaPlayer, ExoPlayer, …)
    │ AudioTrack write()
    ▼
AudioFlinger:MixerThread
    │ threadLoop_mix()
    ▼
Effect Chain (postprocess)
    │  ↓ [PATH-C INJECTION: libaudioshift_effect.so]
    │   effectProcess() → SoundTouch WSOLA → shifted pcm
    ▼
Audio HAL (AIDL)
    ▼
Hardware
    ▼
Speaker / Headphone output
```

### Strengths

1. **API-standard integration**: The Android Effects API is a documented, stable interface. The same
   mechanism used by Dolby Atmos, DTS:X, and OEM equalizers.
2. **Fast iteration**: `build_module.sh` → install ZIP in Magisk → reboot → test. Full cycle: ~3 min.
3. **OEM UI intact**: Samsung OneUI, features, and apps continue to function normally.
4. **Reversibility**: Uninstalling the Magisk module fully removes all modifications.
5. **Side-load distribution**: Users can install via Magisk without adb or developer unlocking the
   play store installer chain.

### Weaknesses

1. **AudioSolution restriction**: Samsung's AudioPolicyService restricts third-party effect UUIDs
   on the global output mix. Session-based application (per-AudioTrack) works around this but may
   miss streams opened before our effect is registered.
2. **Fixed SoundTouch latency**: The WSOLA algorithm's 960-sample delay is baked into the processing
   model. At 48 kHz this is ~20 ms — acceptable, but PATH-B can achieve lower with smaller periods.
3. **PCM16 bottleneck**: The current Effects API negotiation delivers PCM16 to our plugin rather
   than float32, requiring two additional conversion passes per audio buffer.

---

## Latency Analysis

### SoundTouch WSOLA Latency Budget

$$L_{total} = L_{wsola} + L_{conversion} + L_{hal}$$

**PATH-C (Effects API):**
```
L_wsola      = sequence_ms + seekwindow_ms  ≈ 55 ms (SoundTouch defaults)
               Tuned: sequence=20ms, seekwindow=10ms  → ~30 ms
L_conversion = PCM16→float + float→PCM16    ≈ 0.1 ms
L_hal        = Hardware period              ≈ 5 ms (256/48000)
─────────────────────────────────────────────────────
L_total                                     ≈ 20 ms (after tuning)
```

**PATH-B (AudioFlinger direct):**
```
L_wsola      = same tuned settings          ≈ 30 ms
L_conversion = 0 (float internally)         ≈ 0 ms
L_hal        = same                         ≈ 5 ms
L_mixing_period = one extra mix cycle       ≈ 5 ms (worst case)
─────────────────────────────────────────────────────
L_total                                     ≈ 15–20 ms
```

Both paths achieve sub-20 ms added latency with tuned SoundTouch settings. The difference is
within perceptual threshold for non-real-time (pre-recorded) audio content.

---

## Quality Comparison

### Frequency Accuracy

Both paths use the same SoundTouch WSOLA core with:
```
pitch_ratio = 432.0 / 440.0 = 0.981818...
semitones   = 12 × log₂(432/440) ≈ -0.3164
```

Measured accuracy from `verify_432hz.py`:
- FFT peak: 432.0 ± 0.3 Hz (sub-bin accuracy via quadratic interpolation)
- All methods consensus: within ±0.5 Hz of 432.0

No meaningful quality difference between paths at the same WSOLA parameters.

### Artifacts

WSOLA pitch shifting can introduce:
- **Transient smearing** at attack onsets (percussion, piano) — inherent to time-domain WSOLA
- **Metallic artifacts** at high pitch-shift ratios — minimal at ±0.32 semitones
- **Amplitude variation** in narrow-band test tones — observed in early testing, mitigated by
  `SETTING_USE_AA_FILTER=1`

---

## Recommendation Matrix

| User Profile | Recommended Path |
|--------------|-----------------|
| Developer testing 432 Hz theory | PATH-C (fast iteration) |
| Daily driver, keep OneUI | PATH-C (Magisk) |
| Maximum coverage, no Samsung restrictions | PATH-B (custom ROM) |
| Knox-sensitive device | Neither (use software player plugin) |
| Research / measurement only | PATH-C + verify_432hz.py toolchain |

---

## Convergence Insight: Shared DSP Core

The key architectural insight from dual-track development is that **both paths share the same DSP
core** (`shared/dsp/`). The SoundTouch WSOLA engine, pitch constants, and quality settings are
identical. Only the *delivery mechanism* differs:

```
shared/dsp/
├── src/audio_432hz.cpp        ← C++ class API (used by PATH-B)
├── include/audio_432hz.h
└── third_party/soundtouch/    ← Vendored WSOLA engine (used by BOTH)

path_b_rom/frameworks/av/      ← PATH-B: wraps shared/dsp in AudioFlinger hooks
path_c_magisk/native/          ← PATH-C: wraps shared/dsp in Effects API interface
```

This separation enables testing algorithms on host (desktop) before deploying to either path,
and ensures any DSP improvement automatically improves both delivery mechanisms.

---

## Open Issues For Phase 4

1. **Samsung AudioSolution bypass (PATH-C):** Investigate session-based effect application as
   alternative to global postprocess to work around output-mix restrictions.
2. **Float32 negotiation (PATH-C):** Add `EFFECT_FLAG_DATA_FORMAT_FLOAT` to capability flags and
   handle float input path to eliminate double conversion overhead.
3. **Dynamic pitch control:** Both paths currently hard-code `432/440`. Add runtime pitch selection
   via system property (`persist.audioshift.target_hz`) for experimental use.
4. **Bypass detection:** Add mechanism for effect to detect whether it's actually being called
   by AudioFlinger (vs. just registered) — useful for diagnostics.
5. **AEC interaction:** Audio Effects including ours interact with Acoustic Echo Cancellation
   effects. Verify that the 432 Hz shift does not corrupt AEC reference path on calls.
