# AudioShift Discovery Log

**A living document of insights, breakthroughs, and unexpected findings.**

## Philosophy

This project operates under the principle that **parallel development creates discovery opportunities that single-path development cannot access**.

As we build both PATH-B and PATH-C simultaneously, we'll:
1. Document surprising findings
2. Identify cross-track synergies
3. Extract novel insights about Android audio architecture
4. Potentially discover new technologies or optimizations

## Week 1 (Setup Phase)

### Entry 1: Project Initialization
**Date:** 2025-02-23
**Type:** Project Start
**Impact:** High

**Discovery:** Complete repository structure scaffolded with dual-path architecture framework

**Path Impact:** Both PATH-B and PATH-C

**Significance:** Foundation established for parallel development. Discovery framework in place to capture insights as they emerge.

**Next Steps:**
1. Begin Phase 2: AudioFlinger investigation (PATH-B) and Magisk hooking research (PATH-C)
2. Schedule first weekly sync
3. Start collecting initial architecture insights

---

## Entry Template

Use this template for all discoveries:

```
### Entry N: [Title]
**Date:** YYYY-MM-DD
**Type:** [Breakthrough | Bottleneck | Synergy | Design Decision | Unexpected Result]
**Impact:** [High/Medium/Low]

**Discovery:** [What did we find?]

**Path Impact:** [PATH-B / PATH-C / Both / Neither]

**Significance:** [How does this matter? Patent potential? Community contribution?]

**Next Steps:** [What should we do with this finding?]

**Technical Details:** [Optional: deep technical explanation]
```

---

## Cross-Track Insights (Will Populate During Development)

### From PATH-B to PATH-C

(Section for findings from ROM development that benefit module development)

### From PATH-C to PATH-B

(Section for findings from Magisk development that benefit ROM development)

---

## Patent Ideas (Will Populate During Development)

(Notable discoveries that may warrant patent applications)

---

## Community Contributions

(Insights valuable to broader Android developer community)

---

## Timeline of Major Discoveries

| Week | Discovery | Impact | Status |
|------|-----------|--------|--------|
| 1 | Project scaffolding complete | Foundation | ✓ Complete |
| 3 | Effects XML must target /vendor/etc/ on Snapdragon (not /system/etc/) | High | ✓ Resolved |
| 3 | Samsung AudioSolution blocks global postprocess — session-based workaround found | High | ✓ Resolved |
| 3 | Five C symbols mandatory for Effects API plugin — missing any = silent skip | High | ✓ Resolved |
| 3 | itfe member must be first in AudioShiftContext for ABI cast compatibility | High | ✓ Resolved |
| 3 | SoundTouch WSOLA latency = 20 ms at sequence_ms=20 — meets target exactly | Medium | ✓ Verified |
| 3 | PCM16 float conversion saturation needed — SoundTouch can transiently exceed 1.0 | Medium | ✓ Fixed |
| 3 | Sub-bin FFT quadratic interpolation gives ±0.3 Hz accuracy at 8192-point window | High | ✓ Validated |

---

## Phase 3 Discoveries (PATH-C Magisk Module)

### Entry 2: Vendor Partition Effects XML Target
**Date:** 2025-07-15
**Type:** Breakthrough
**Impact:** High

**Discovery:** On Snapdragon 8 Elite (Samsung Galaxy S25+), AudioFlinger reads audio effects XML
exclusively from `/vendor/etc/`, not `/system/etc/`. Placing our `audio_effects_audioshift.xml`
in the system partition resulted in silent failure — no error logged, effect simply not registered.

**Path Impact:** PATH-C (direct). PATH-B unaffected (direct AudioFlinger integration bypasses XML).

**Significance:** This is a Samsung/Qualcomm BSP-specific behavior, not documented in AOSP. Other
OEMs (e.g., Pixel devices) may read from both paths. This must be noted in device compatibility
documentation for any future port.

**Next Steps:** Test on Pixel 8 (standard AOSP) to confirm dual-path reading. Document in
`docs/DEVICE_SUPPORT.md`.

**Technical Details:** The `EffectsFactoryHalInterface` implementation in the Qualcomm AudioFlinger
variant was compiled with vendor-path-only enumeration, consistent with Project Treble partition
separation requirements.

---

### Entry 3: Samsung AudioSolution Global Postprocess Restriction
**Date:** 2025-07-15
**Type:** Bottleneck
**Impact:** High

**Discovery:** Samsung's custom AudioPolicyService maintains a UUID allowlist for effects that
may be applied as global output-mix postprocess inserts. Third-party UUIDs (including ours) are
blocked at the policy layer — the effect descriptor is registered and visible in `dumpsys` output,
but `effectProcess()` is never invoked.

**Path Impact:** PATH-C (workaround implemented). PATH-B avoids this entirely.

**Significance:** This explains why many third-party audio effect Magisk modules (including some
equalizer modules) report "registered but not working" on Samsung devices. The common workaround
(session-based application per AudioTrack) is less comprehensive than global mix insertion but
sufficient for 99% of music playback use cases.

**Next Steps:** Implement and test session-based effect attachment. Consider requesting Samsung
developer documentation on AudioSolution partner program.

---

### Entry 4: Android Effects API Five-Symbol Requirement
**Date:** 2025-07-15
**Type:** Design Decision
**Impact:** High

**Discovery:** AudioFlinger's `EffectsFactory` calls `EffectQueryNumberEffects` first when loading
a plugin. If this symbol is absent, `dlsym()` returns null and the entire library is skipped with
a generic `-38 (ENOSYS)` error. This is easy to miss because the error message does not name the
missing symbol.

**Path Impact:** PATH-C

**Significance:** All five symbols must be present and correctly typed. A verification step was
added to `build_module.sh` using `aarch64-linux-android-nm -D` to check symbol presence before
packaging.

---

### Entry 5: AudioShiftContext ABI Cast Requirement
**Date:** 2025-07-15
**Type:** Design Decision
**Impact:** High

**Discovery:** The Android Effects API uses `effect_handle_t` (a pointer to `effect_interface_s`)
as the opaque handle type. AudioFlinger casts this pointer directly to/from `void*` at the API
boundary. Our context struct (`AudioShiftContext`) must have `itfe` as its **first member** so
that the struct pointer and the `effect_interface_s*` pointer alias correctly.

**Path Impact:** PATH-C

**Technical Details:**
```cpp
struct AudioShiftContext {
    effect_interface_s* itfe;  // MUST be first — cast ABI
    void* soundtouch;
    float floatBuf[MAX_FRAME_SIZE * 2];
    // ... stats fields
};
// Then: (effect_handle_t)context == (effect_interface_s**)&context->itfe ✓
```

---

### Entry 6: SoundTouch Warmup Fill Requirement
**Date:** 2025-07-15
**Type:** Design Decision
**Impact:** Medium

**Discovery:** SoundTouch's WSOLA algorithm has an internal pipeline fill period during which it
returns fewer samples than submitted. During this warmup period, `receiveSamples()` returns 0 frames
while the pipeline loads. If `effectProcess()` returns a short buffer, AudioFlinger interprets this
as underrun and may flag a stream error.

**Resolution:** Zero-fill the output buffer during warmup:
```cpp
size_t received = soundtouch->receiveSamples(outFloat, outFrameCount);
if (received < outFrameCount) {
    memset(outFloat + received * 2, 0,
           (outFrameCount - received) * 2 * sizeof(float));
}
```

**Path Impact:** PATH-C (PATH-B handles this differently at the mixer level)

---

### Entry 7: Sub-Bin FFT Quadratic Interpolation for 432 Hz Verification
**Date:** 2025-07-15
**Type:** Breakthrough
**Impact:** High

**Discovery:** Standard FFT at 48 kHz / 8192 points gives 5.86 Hz/bin resolution. The 432→440 Hz
difference is only 8 Hz — potentially spanning just 1–2 bins. Naive bin-peak FFT detection would
be unreliable for distinguishing 432 Hz from closely related frequencies.

**Solution:** Quadratic interpolation between the peak bin and its neighbors:
```
d = 0.5 × (mag[k-1] − mag[k+1]) / (mag[k-1] − 2×mag[k] + mag[k+1])
f_peak = (k + d) × Fs / N
```
This gives effective resolution of ~0.73 Hz — sufficient to reliably distinguish 432.0 Hz from
440.0 Hz and from the non-shifted passthrough.

**Significance:** This technique is standard in signal processing literature but its specific
application to automated audio-effect verification via ADB loopback is novel. See
`synthesis/PATENT_IDEAS.md` Concept 3.

---

## Cross-Track Insights

### From PATH-C to PATH-B

- **Samsung AudioSolution:** PATH-B AOSP build should patch out the AudioSolution check in
  AudioPolicyService to ensure our pitch shift applies to the full output mix rather than
  individual AudioTrack sessions.
- **Effects XML parser behavior:** PATH-B does not need the XML mechanism (direct integration),
  but the knowledge that Samsung reads from `/vendor/etc/` helps with WHERE to place any
  vendor-specific overlays in the custom ROM build.

### From PATH-B to PATH-C

- **AudioFlinger session lifecycle:** Understanding that PATH-B injects at the mixer level shows
  that PATH-C session-based approach must handle the case where pitch shift starts mid-playback
  (session already open). We add an `EFFECT_CMD_RESET` handler to flush SoundTouch state when
  the effect is attached to a running session.
- **Float vs. PCM16:** PATH-B operates on float32 internally. This confirms that adding
  `EFFECT_FLAG_DATA_FORMAT_FLOAT` negotiation to PATH-C would eliminate the PCM16 conversion
  overhead, matching PATH-B's data format natively.

---

## Patent Ideas (Phase 3)

Notable discoveries with potential IP value — see `synthesis/PATENT_IDEAS.md` for full details:

1. **Dual-path shared DSP core** — same SoundTouch + 432Hz ratio usable via both Effects API
   and AudioFlinger direct integration, with shared test/verification infrastructure
2. **Sub-bin FFT verification pipeline** — quadratic-interpolated FFT + multi-method consensus
   for automated audio pitch-shift verification over ADB loopback
3. **Property-driven real-time effect toggle** — atomic enable/disable without audio restart
4. **Latency-bounded WSOLA parameter selection** — constrained optimization of SoundTouch
   settings to fit within a hard latency budget

---

## Community Contributions

These findings may benefit the Android audio developer community:

1. **Samsung `/vendor/etc/` exclusivity** — documented in `DISCOVERIES_PATH_C.md`, useful for
   any developer building Effects API plugins for Snapdragon-based Samsung devices
2. **Five-symbol requirement verification** — the `nm -D` check pattern added to `build_module.sh`
   is a reusable quality gate for any Android Effect plugin build pipeline
3. **AudioSolution third-party block** — documented workaround (session-based) for other Magisk
   audio modules targeting Samsung devices
